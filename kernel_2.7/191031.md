# 15章5～10
## 前回の復習+
* inodeはindex_nodeの略であり、1つのファイルやディレクトリに対して一意に対応する管理情報が保存されているデータ構造。
* dentryはファイルの使用が終了しても再び使用されることに備えて直ぐには解放しない。ページの回収処理の際に解放される。
* super_block構造体：ファイルシステム共有の管理情報を扱う。
* vfsmount構造体：マウントされたファイルシステムの位置関係の管理。

## 15.5 inode構造体の管理構造
 inode構造体もハッシュ化リンクとつながっており、inodeのヘッドはsuper_block構造体のアドレスとiノード番号から計算される。   
  
 また、inode構造体はi_listメンバーを用いて状態を表すリストにつながる。  
 ![ハッシュ化リンクにつながっているinode構造体](./img/15-11.png)
   
inode構造体はdentry構造体と相互にポイントしているため、dentry構造体が解放された後に解放される。そのため、inode構造体のハッシュ化リストはdentry構造体の登場以降、使う機会が減少した。  

`$df -i` で現在のinode領域の使用状況を確認できる。各項目の意味は以下の通り  
* Inodes： デバイスで作成できるinodeの限界値
* IUsed ： 現在の使用量
* IFree ： 残り
* IUse  ： 使用率
  
また `$ls -i` によってinode番号を見ることができる。

## 15.6 super_block構造体の管理構造
super_blocksをヘッドとしてファイルシステムの種別が同じfile_system_type構造体のリンクとつながっている。  
リンクリストはまとめて書き込むためにキャッシュしているデータをディスクに書き込むsync処理などの全ファイルシステムを検索する際に使用される。  
  
### file_system_type
この構造体は各ファイルシステム種別ごとに存在する。  
リンクリストはマウント処理時に同じファイルシステムがマウントされていないか確認する際に使用される。  
![super_block構造体のリンク関係](./img/15-12.png)
  
## 15.7 名前空間の構成
Linuxの名前空間はファイルシステムによってあるパーティションとあるディレクトリを関連づける操作(マウント)をすることによって構成されている。  

### vfsmount構造体
マウント関係の保持のための管理構造。名前空間上のでのファイルシステムの根幹。もちろんハッシュリストにつながっている。  
mnt_sbが実体のファイルシステムであるsuper_block構造体へ一方的にポイントしている。  
同じファイルシステムに複数ディレクトリがマウントしている際にvfsmount構造体はマウントごとに存在するが、super_block構造体は1つに限る。  
マウント関係を表すmnt_mountsをvfsmount構造体につなげることで親子関係をつくることができる。  
ハッシュのヘッダは親vfsmount構造体のアドレスとdentry構造体のアドレスから計算される。この構造体の検索処理を用いてパス名のルックアップ処理ができる。逆に、dentry構造体はマウントしているvfsmount構造体を記憶していないため、vsfmount構造体を用いる必要がある。ヘッダ数は1ページ分確保される。  
  
### namespace構造体

### fs_struct構造体

## 15.8 ファイルオペレーション・15章まとめ
VFS層の役割はファイルシステムへ処理を振ることであるとも言える。その処理方法はファイルシステムが各自inode構造体に関数を設定しており、VFS層には複雑な操作を必要とせずに、関数の呼び出しをすることで処理をすることができるような構造になっている。また、ファイルシステムの判別はオペレーションの有無によって行うこともある。  

## 15.9 名前空間の実装
### パス名ルックアップ処理の実装
### マウント、アンマウントの実装

## 参考
* [Linuxのファイルシステムについて](https://qiita.com/kamihork/items/fbcd116a631324aae05d)
* Linuxカーネル解読室2.6 15章
