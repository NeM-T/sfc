# 21章

## 21.1 階層モデル
ネットワークは階層化された構成になっていて、その階層の代表的なものはISOが提唱したOSI参照モデルである。その構成は以下のものである。  
|||TCP/IPの対応|
|:-:|:-:|:-:|
|アプリケーション層|アプリケーション|アプリケーション|
|プレゼンテーション層|データ形式の変換||
|セッション層|テータ経路の確立||
|トランスポート層|信頼性のある通信|TCP,UDP|
|ネットワーク層|経路を選んで通信|IP|
|データリンク層|２点間の誤りのないフレームの送受信|イーサネット|
|物理層|信号の伝達|イーサネット|  
  
ネットワークには多くのプロトコルがあり、Linuxでも多くに対応している。この本においては(この時点に置いては)事実上標準である、IPv4を扱う。  


## 21.2 全体像
階層モデルにおいて隣り合うもの同士はAPIを提供しそれのみを使用する。Linuxにおいては以下の構成となっている。  
  
### アプリケーション側インターフェイス
ユーザープロセス（アプリケーション用API）としてLinuxはBerkeleyソケットインターフェイスをサポートしている。ソケットインターフェイスはsocket構造体とproto_opt構造体に実装され、カーネル内での実体はsock構造体とproto構造体のなる（プロセスコンテキストで実装される）。  
ソケットにプロトコルを登録・削除する関数はsock_register・sock_unregister関数である。この登録はソケットインターフェイスに対して独自の処理をしたい場合のnet_proto_family構造体へ登録するために使用される。  
  
### ネットワークデバイス側インターフェイス
一方、NICから見た場合、割り込みによってコンテキストで処理するAPIであり、受け取ったデータをネットワーク層に引き渡す。  
この際、データを処理するために処理するパケットタイプと関数をpacket_type構造体として登録することで該当するパケッ卜タイプを受け取ったときにソフトウェア割り込みが発生し、パケットタイプに応じて、登録された関数が呼び出される。  
tcpdumpなどで使用されるネットワークデバイスへの直接アクセスを可能にするPacket_socketでは初期化時にnet_proto_family構造体のみを登録し、動的にpacket_type構造体の登録を行う。  
UNIXドメインの場合、内部データのやり取りであるため、net_proto_family構造体の登録のみ行われ、外部データの処理の際に使用されるpacket_type構造体は登録しないが、TCP/IPの場合、外部データを処理するため、両方の登録が行われる。  

## 21.3 ソケットインターフェイス
アプリケーションがネットワークを使用する際には
1. socketシステムコールでソケットを作成し、ファイルディスクリプタを取得
2. connect/bind/listen/acceptシステムコールで接続
3. send/recvでデータをやり取りし、
4. shutdownシステムコールで接続を終了
5. closeでファイルディスクリプタの解放を行う  
というフローになる。  
3のsend/recvはソケット専用のシステムコールであるが汎用ファイルインターフェースのread/writeを使うことも可能であり、shutdownをしなくともcloseによって接続は切断される。また、従来のファイルI/O用インターフェースのselect/poll/epoll/ioctlも通常のファイルと同様使用できる。  
### socketcall

## 21.4 ソケットバッファとソケットバッファヘッド

## 21.5 ネットデバイス

## 21,6 ルーティングセット

